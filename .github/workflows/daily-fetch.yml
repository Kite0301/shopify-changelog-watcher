name: Daily RSS Fetch

on:
  schedule:
    # æ¯æ—¥ 9:00 JST (00:00 UTC)
    - cron: '0 0 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯

jobs:
  fetch-and-update:
    runs-on: ubuntu-latest

    permissions:
      contents: write # ãƒªãƒã‚¸ãƒˆãƒªã¸ã®æ›¸ãè¾¼ã¿æ¨©é™

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Fetch RSS feeds
        id: fetch
        run: |
          # RSSå–å¾—ã‚’å®Ÿè¡Œã—ã€å‡ºåŠ›ã‚’ä¿å­˜
          npm run fetch > fetch-output.txt 2>&1

          # å‡ºåŠ›ã‹ã‚‰çµ±è¨ˆæƒ…å ±ã‚’æŠ½å‡º
          NEW_ENTRIES=$(grep "New entries added:" fetch-output.txt | awk '{print $4}')
          TOTAL_ENTRIES=$(grep "Total entries:" fetch-output.txt | awk '{print $3}')

          # ç’°å¢ƒå¤‰æ•°ã«è¨­å®š
          echo "new_entries=${NEW_ENTRIES:-0}" >> $GITHUB_OUTPUT
          echo "total_entries=${TOTAL_ENTRIES:-0}" >> $GITHUB_OUTPUT

          # å‡ºåŠ›å†…å®¹ã‚’è¡¨ç¤º
          cat fetch-output.txt

      - name: Run AI analysis on new entries
        id: analyze
        if: steps.fetch.outputs.new_entries != '0'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # æœªåˆ†æã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã‚’åˆ†æ
          npm run analyze > analyze-output.txt 2>&1

          # å‡ºåŠ›ã‹ã‚‰çµ±è¨ˆæƒ…å ±ã‚’æŠ½å‡º
          ANALYZED=$(grep "Successfully analyzed:" analyze-output.txt | awk '{print $3}')

          # ãƒ¢ãƒ‡ãƒ«åˆ¥ã®ã‚³ã‚¹ãƒˆã¨ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’æŠ½å‡º
          CLAUDE_COST=$(grep -A 4 "claude-sonnet-4-5:" analyze-output.txt | grep "Total cost:" | awk '{print $3}' | sed 's/\$//')
          CLAUDE_TOKENS=$(grep -A 4 "claude-sonnet-4-5:" analyze-output.txt | grep "Total tokens:" | awk '{print $3}' | sed 's/,//g')
          GEMINI_COST=$(grep -A 4 "gemini-2.5-flash:" analyze-output.txt | grep "Total cost:" | awk '{print $3}' | sed 's/\$//')
          GEMINI_TOKENS=$(grep -A 4 "gemini-2.5-flash:" analyze-output.txt | grep "Total tokens:" | awk '{print $3}' | sed 's/,//g')

          # ç’°å¢ƒå¤‰æ•°ã«è¨­å®š
          echo "analyzed=${ANALYZED:-0}" >> $GITHUB_OUTPUT
          echo "claude_cost=${CLAUDE_COST:-0.0000}" >> $GITHUB_OUTPUT
          echo "claude_tokens=${CLAUDE_TOKENS:-0}" >> $GITHUB_OUTPUT
          echo "gemini_cost=${GEMINI_COST:-0.0000}" >> $GITHUB_OUTPUT
          echo "gemini_tokens=${GEMINI_TOKENS:-0}" >> $GITHUB_OUTPUT

          # å‡ºåŠ›å†…å®¹ã‚’è¡¨ç¤º
          cat analyze-output.txt

      - name: Extract new entry titles
        id: extract_titles
        if: steps.fetch.outputs.new_entries != '0'
        run: |
          # entries.jsonã‹ã‚‰æ–°ç€ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŠ½å‡º
          # æœ€æ–°ã®Nä»¶ã‚’å–å¾—ï¼ˆæ–°ç€ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ•°åˆ†ï¼‰
          NEW_COUNT=${{ steps.fetch.outputs.new_entries }}

          # jqã‚’ä½¿ç”¨ã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŠ½å‡ºã—ã€æ”¹è¡ŒåŒºåˆ‡ã‚Šã§çµåˆ
          TITLES=$(jq -r --argjson count "$NEW_COUNT" '.entries[:$count] | .[] | "â€¢ " + .title' data/entries.json | head -n 10)

          # Slackç”¨ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆè¤‡æ•°è¡Œã‚’\nã§ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰
          TITLES_FORMATTED=$(echo "$TITLES" | sed ':a;N;$!ba;s/\n/\\n/g')

          # 10ä»¶ã‚’è¶…ãˆã‚‹å ´åˆã¯çœç•¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
          if [ "$NEW_COUNT" -gt 10 ]; then
            REMAINING=$((NEW_COUNT - 10))
            TITLES_FORMATTED="${TITLES_FORMATTED}\\n_...and ${REMAINING} more_"
          fi

          echo "titles<<EOF" >> $GITHUB_OUTPUT
          echo -e "$TITLES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "titles_formatted=$TITLES_FORMATTED" >> $GITHUB_OUTPUT

      - name: Check for changes
        id: check_changes
        run: |
          if [[ -n $(git status -s data/entries.json) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add data/entries.json
          git commit -m "Update changelog entries with AI analysis (automated)

          New entries: ${{ steps.fetch.outputs.new_entries }}
          Analyzed: ${{ steps.analyze.outputs.analyzed }}
          Total entries: ${{ steps.fetch.outputs.total_entries }}

          AI Analysis:
          - Claude Sonnet 4.5: \$${{ steps.analyze.outputs.claude_cost }} (${{ steps.analyze.outputs.claude_tokens }} tokens)
          - Gemini 2.5 Flash: \$${{ steps.analyze.outputs.gemini_cost }} (${{ steps.analyze.outputs.gemini_tokens }} tokens)

          ğŸ¤– Automated update by GitHub Actions"

          git push

      - name: Send Slack notification (success with new entries)
        if: success() && steps.check_changes.outputs.changes == 'true'
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            {
              "text": "ğŸ“° Shopify Changelog Update",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸ“° New Shopify Changelog Entries Detected"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*New Entries:*\n${{ steps.fetch.outputs.new_entries || '0' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Analyzed:*\n${{ steps.analyze.outputs.analyzed || '0' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Total Entries:*\n${{ steps.fetch.outputs.total_entries || '0' }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*New Articles:*\n${{ steps.extract_titles.outputs.titles }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*AI Analysis Cost:*\nâ€¢ Claude Sonnet 4.5: $$${{ steps.analyze.outputs.claude_cost || '0.0000' }} (${{ steps.analyze.outputs.claude_tokens || '0' }} tokens)\nâ€¢ Gemini 2.5 Flash: $$${{ steps.analyze.outputs.gemini_cost || '0.0000' }} (${{ steps.analyze.outputs.gemini_tokens || '0' }} tokens)"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "View the changes on <https://kite0301.github.io/shopify-changelog-watcher/|GitHub Pages>"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "Workflow: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|${{ github.workflow }}>"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Send Slack notification (no new entries)
        if: success() && steps.check_changes.outputs.changes == 'false'
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            {
              "text": "âœ… Shopify Changelog Check Complete - No New Entries",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "âœ… Daily changelog check completed. No new entries found.\n\n*Total Entries:* ${{ steps.fetch.outputs.total_entries || '0' }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Send Slack notification (failure)
        if: failure()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            {
              "text": "âŒ Shopify Changelog Fetch Failed",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "âŒ Changelog Fetch Failed"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "The daily RSS fetch workflow encountered an error.\n\nPlease check the <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|workflow logs> for details."
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
